

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>greybox.alm &mdash; greybox 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            greybox
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributions/index.html">Distributions Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/config-i1/greybox">GitHub Repository</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/greybox/">Python Package Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">greybox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">greybox.alm</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for greybox.alm</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Augmented Linear Model (ALM) for greybox.</span>

<span class="sd">This module provides the ALM estimator following scikit-learn principles.</span>
<span class="sd">Users should first use the formula module to get X and y, then pass them</span>
<span class="sd">to the fit() method.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">time_module</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nlopt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.fitters</span><span class="w"> </span><span class="kn">import</span> <span class="n">scaler_internal</span><span class="p">,</span> <span class="n">extractor_fitted</span><span class="p">,</span> <span class="n">extractor_residuals</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.cost_function</span><span class="w"> </span><span class="kn">import</span> <span class="n">cf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">distributions</span> <span class="k">as</span> <span class="n">dist</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.methods.summary</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummaryResult</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_numerical_hessian</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Numerical Hessian via central finite differences.</span>

<span class="sd">    Matches R&#39;s pracma::hessian() with fixed step size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f : callable</span>
<span class="sd">        Scalar function of a vector argument.</span>
<span class="sd">    x0 : np.ndarray</span>
<span class="sd">        Point at which to evaluate the Hessian.</span>
<span class="sd">    h : float, optional</span>
<span class="sd">        Step size. Default: eps^(1/4) matching R.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    H : np.ndarray</span>
<span class="sd">        Hessian matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">**</span> <span class="mf">0.25</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">hh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">hh</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">hi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">f0</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">hi</span><span class="p">))</span> <span class="o">/</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">hj</span> <span class="o">=</span> <span class="n">hh</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">f</span><span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">hi</span> <span class="o">+</span> <span class="n">hj</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">hi</span> <span class="o">-</span> <span class="n">hj</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">hi</span> <span class="o">+</span> <span class="n">hj</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">hi</span> <span class="o">-</span> <span class="n">hj</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">H</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">H</span>


<div class="viewcode-block" id="PredictionResult">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.PredictionResult">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PredictionResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prediction result object with mean, interval bounds, and metadata.</span>

<span class="sd">    Supports DataFrame-like access: indexing by column name, len(),</span>
<span class="sd">    iteration, and conversion to pandas DataFrame via to_dataframe().</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : np.ndarray</span>
<span class="sd">        Predicted values (point forecasts).</span>
<span class="sd">    lower : np.ndarray or None</span>
<span class="sd">        Lower prediction bounds.</span>
<span class="sd">    upper : np.ndarray or None</span>
<span class="sd">        Upper prediction bounds.</span>
<span class="sd">    level : float or list[float] or None</span>
<span class="sd">        Confidence level(s) used for the intervals.</span>
<span class="sd">    variances : np.ndarray or None</span>
<span class="sd">        Variance estimates for each observation.</span>
<span class="sd">    side : str</span>
<span class="sd">        Side of interval: &quot;both&quot;, &quot;upper&quot;, or &quot;lower&quot;.</span>
<span class="sd">    interval : str</span>
<span class="sd">        Type of interval: &quot;none&quot;, &quot;confidence&quot;, or &quot;prediction&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="s2">&quot;variances&quot;</span><span class="p">,</span> <span class="s2">&quot;side&quot;</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lower</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">variances</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variances</span> <span class="o">=</span> <span class="n">variances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">=</span> <span class="n">side</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>

<div class="viewcode-block" id="PredictionResult.to_dataframe">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.PredictionResult.to_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to a pandas DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame with &#39;mean&#39; column and optional &#39;lower&#39;/&#39;upper&#39;</span>
<span class="sd">            columns (or &#39;lower_0&#39;, &#39;upper_0&#39;, etc. for multiple levels).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;lower_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;upper_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[</span><span class="n">key</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Column names of the DataFrame representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of the DataFrame representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Index of the DataFrame representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Values of the DataFrame representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">values</span></div>



<span class="n">NLOPT_ALGORITHMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;NLOPT_LN_NELDERMEAD&quot;</span><span class="p">:</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">LN_NELDERMEAD</span><span class="p">,</span>
    <span class="s2">&quot;NLOPT_LN_SBPLX&quot;</span><span class="p">:</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">LN_SBPLX</span><span class="p">,</span>
    <span class="s2">&quot;NLOPT_LN_COBYLA&quot;</span><span class="p">:</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">LN_COBYLA</span><span class="p">,</span>
    <span class="s2">&quot;NLOPT_LN_BOBYQA&quot;</span><span class="p">:</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">LN_BOBYQA</span><span class="p">,</span>
    <span class="s2">&quot;NLOPT_LN_NEWUOA&quot;</span><span class="p">:</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">LN_NEWUOA</span><span class="p">,</span>
    <span class="s2">&quot;NLOPT_LN_PRAXIS&quot;</span><span class="p">:</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">LN_PRAXIS</span><span class="p">,</span>
    <span class="s2">&quot;NLOPT_LD_LBFGS&quot;</span><span class="p">:</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">LD_LBFGS</span><span class="p">,</span>
    <span class="s2">&quot;NLOPT_LD_SLSQP&quot;</span><span class="p">:</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">LD_SLSQP</span><span class="p">,</span>
    <span class="s2">&quot;NLOPT_LD_MMA&quot;</span><span class="p">:</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">LD_MMA</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="ALM">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.ALM">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ALM</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Augmented Linear Model estimator.</span>

<span class="sd">    This estimator fits a linear model with various distributions and loss</span>
<span class="sd">    functions, following scikit-learn principles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    distribution : str, default=&quot;dnorm&quot;</span>
<span class="sd">        Distribution name. Options: &quot;dnorm&quot;, &quot;dlaplace&quot;, &quot;ds&quot;, &quot;dgnorm&quot;,</span>
<span class="sd">        &quot;dlogis&quot;, &quot;dt&quot;, &quot;dalaplace&quot;, &quot;dlnorm&quot;, &quot;dllaplace&quot;, &quot;dls&quot;,</span>
<span class="sd">        &quot;dlgnorm&quot;, &quot;dbcnorm&quot;, &quot;dfnorm&quot;, &quot;drectnorm&quot;, &quot;dinvgauss&quot;,</span>
<span class="sd">        &quot;dgamma&quot;, &quot;dexp&quot;, &quot;dchisq&quot;, &quot;dgeom&quot;, &quot;dpois&quot;, &quot;dnbinom&quot;,</span>
<span class="sd">        &quot;dbinom&quot;, &quot;dlogitnorm&quot;, &quot;dbeta&quot;, &quot;plogis&quot;, &quot;pnorm&quot;.</span>
<span class="sd">    loss : str, default=&quot;likelihood&quot;</span>
<span class="sd">        Loss function. Options: &quot;likelihood&quot;, &quot;MSE&quot;, &quot;MAE&quot;, &quot;HAM&quot;,</span>
<span class="sd">        &quot;LASSO&quot;, &quot;RIDGE&quot;, &quot;ROLE&quot;.</span>
<span class="sd">    occurrence : str, default=&quot;none&quot;</span>
<span class="sd">        Occurrence model for zero-inflated data. Options: &quot;none&quot;,</span>
<span class="sd">        &quot;plogis&quot;, &quot;pnorm&quot;.</span>
<span class="sd">    scale_formula : array-like or None, default=None</span>
<span class="sd">        Formula for scale parameter. If None, scale is constant.</span>
<span class="sd">    orders : tuple, default=(0, 0, 0)</span>
<span class="sd">        ARIMA orders (p, d, q).</span>
<span class="sd">    alpha : float, optional</span>
<span class="sd">        Additional parameter for Asymmetric Laplace distribution.</span>
<span class="sd">    shape : float, optional</span>
<span class="sd">        Shape parameter for Generalized Normal distribution.</span>
<span class="sd">    lambda_bc : float, optional</span>
<span class="sd">        Box-Cox lambda parameter for Box-Cox Normal distribution.</span>
<span class="sd">    size : float, optional</span>
<span class="sd">        Size parameter for Negative Binomial/Binomial distributions.</span>
<span class="sd">    nu : float, optional</span>
<span class="sd">        Degrees of freedom for Student&#39;s t or Chi-squared distributions.</span>
<span class="sd">    trim : float, default=0.0</span>
<span class="sd">        Trim proportion for ROLE loss.</span>
<span class="sd">    lambda_l1 : float, optional</span>
<span class="sd">        L1 regularization parameter for LASSO.</span>
<span class="sd">    lambda_l2 : float, optional</span>
<span class="sd">        L2 regularization parameter for RIDGE.</span>
<span class="sd">    nlopt_kargs : dict, optional</span>
<span class="sd">        Dictionary of nlopt parameters. Options:</span>
<span class="sd">        - &quot;algorithm&quot;: str, default=&quot;NLOPT_LN_NELDERMEAD&quot;</span>
<span class="sd">        - &quot;maxeval&quot;: int, default=40 per parameter</span>
<span class="sd">        - &quot;maxtime&quot;: float, default=600 seconds</span>
<span class="sd">        - &quot;xtol_rel&quot;: float, default=1e-6</span>
<span class="sd">        - &quot;xtol_abs&quot;: float, default=1e-8</span>
<span class="sd">        - &quot;ftol_rel&quot;: float, default=1e-4</span>
<span class="sd">        - &quot;ftol_abs&quot;: float, default=0</span>
<span class="sd">        - &quot;print_level&quot;: int, default=0 (0=none, 3=full)</span>
<span class="sd">    verbose : int, default=0</span>
<span class="sd">        Verbosity level.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    coef_ : ndarray of shape (n_features,)</span>
<span class="sd">        Estimated coefficients (excluding intercept).</span>
<span class="sd">    intercept_ : float</span>
<span class="sd">        Estimated intercept.</span>
<span class="sd">    scale_ : float</span>
<span class="sd">        Estimated scale parameter.</span>
<span class="sd">    other_ : dict</span>
<span class="sd">        Other estimated parameters (alpha, shape, etc.).</span>
<span class="sd">    fitted_values_ : ndarray of shape (n_samples,)</span>
<span class="sd">        Fitted values.</span>
<span class="sd">    residuals_ : ndarray of shape (n_samples,)</span>
<span class="sd">        Model residuals.</span>
<span class="sd">    loss_value_ : float</span>
<span class="sd">        Final value of the loss function.</span>
<span class="sd">    log_lik_ : float or None</span>
<span class="sd">        Log-likelihood (only for likelihood-based losses).</span>
<span class="sd">    aic_ : float or None</span>
<span class="sd">        Akaike Information Criterion.</span>
<span class="sd">    bic_ : float or None</span>
<span class="sd">        Bayesian Information Criterion.</span>
<span class="sd">    n_iter_ : int</span>
<span class="sd">        Number of optimization iterations.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from greybox.formula import formula</span>
<span class="sd">    &gt;&gt;&gt; from greybox.alm import ALM</span>
<span class="sd">    &gt;&gt;&gt; data = {&#39;y&#39;: [1, 2, 3, 4, 5], &#39;x1&#39;: [1, 2, 3, 4, 5], &#39;x2&#39;: [2, 3, 4, 5, 6]}</span>
<span class="sd">    &gt;&gt;&gt; y, X = formula(&quot;y ~ x1 + x2&quot;, data)</span>
<span class="sd">    &gt;&gt;&gt; model = ALM(distribution=&quot;dnorm&quot;, loss=&quot;likelihood&quot;)</span>
<span class="sd">    &gt;&gt;&gt; model.fit(X, y)</span>
<span class="sd">    &gt;&gt;&gt; print(model.coef_)</span>

<span class="sd">    &gt;&gt;&gt; # Using nlopt with custom parameters (like R)</span>
<span class="sd">    &gt;&gt;&gt; model = ALM(</span>
<span class="sd">    ...     distribution=&quot;dnorm&quot;,</span>
<span class="sd">    ...     loss=&quot;likelihood&quot;,</span>
<span class="sd">    ...     nlopt_kargs={</span>
<span class="sd">    ...         &quot;algorithm&quot;: &quot;NLOPT_LN_SBPLX&quot;,</span>
<span class="sd">    ...         &quot;maxeval&quot;: 1000,</span>
<span class="sd">    ...         &quot;maxtime&quot;: 600,</span>
<span class="sd">    ...         &quot;xtol_rel&quot;: 1e-8,</span>
<span class="sd">    ...         &quot;print_level&quot;: 1</span>
<span class="sd">    ...     }</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; model.fit(X, y)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DISTRIBUTIONS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;dnorm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dlaplace&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dgnorm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dlogis&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dalaplace&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dlnorm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dllaplace&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dls&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dlgnorm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dbcnorm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dinvgauss&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dgamma&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dexp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dchisq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dfnorm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;drectnorm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dpois&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dnbinom&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dbinom&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dgeom&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dbeta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dlogitnorm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;plogis&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pnorm&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">LOSS_FUNCTIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span> <span class="s2">&quot;MSE&quot;</span><span class="p">,</span> <span class="s2">&quot;MAE&quot;</span><span class="p">,</span> <span class="s2">&quot;HAM&quot;</span><span class="p">,</span> <span class="s2">&quot;LASSO&quot;</span><span class="p">,</span> <span class="s2">&quot;RIDGE&quot;</span><span class="p">,</span> <span class="s2">&quot;ROLE&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">distribution</span><span class="o">=</span><span class="s2">&quot;dnorm&quot;</span><span class="p">,</span>
        <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span>
        <span class="n">occurrence</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">scale_formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">orders</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lambda_bc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">trim</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">lambda_l1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">lambda_l2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nlopt_kargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">=</span> <span class="n">distribution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occurrence</span> <span class="o">=</span> <span class="n">occurrence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_formula</span> <span class="o">=</span> <span class="n">scale_formula</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">=</span> <span class="n">orders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_bc</span> <span class="o">=</span> <span class="n">lambda_bc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trim</span> <span class="o">=</span> <span class="n">trim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_l1</span> <span class="o">=</span> <span class="n">lambda_l1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_l2</span> <span class="o">=</span> <span class="n">lambda_l2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span> <span class="o">=</span> <span class="n">nlopt_kargs</span> <span class="k">if</span> <span class="n">nlopt_kargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_values_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loss_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_lik</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bic</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aicc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bicc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_elapsed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ic_values</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_X_train_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_train_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_formula_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_residual</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_B_opt_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a_parameter_provided_</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_other_val_</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate input parameters.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">DISTRIBUTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid distribution: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Choose from: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">DISTRIBUTIONS</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LOSS_FUNCTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid loss: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="si">}</span><span class="s2">. Choose from: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">LOSS_FUNCTIONS</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;orders must be a tuple of 3 integers (p, d, q)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ALM.fit">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.ALM.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit the ALM model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_features)</span>
<span class="sd">            Design matrix. Should include intercept column (column of ones)</span>
<span class="sd">            as first column if you want an intercept.</span>
<span class="sd">        y : array-like of shape (n_samples,)</span>
<span class="sd">            Target values.</span>
<span class="sd">        formula : str, optional</span>
<span class="sd">            Formula string used to generate X and y. Stored for reference.</span>
<span class="sd">        feature_names : list of str, optional</span>
<span class="sd">            Names for feature columns. If provided, used in print output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : ALM</span>
<span class="sd">            Fitted estimator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">()</span>

        <span class="n">X_is_dataframe</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="n">y_is_series</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">feature_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">X_is_dataframe</span><span class="p">:</span>
            <span class="n">feature_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;(Intercept)&quot;</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>
                <span class="n">feature_names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">)</span>

        <span class="n">response_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">y_is_series</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response_name</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_formula_</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span> <span class="o">=</span> <span class="n">feature_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_name</span> <span class="o">=</span> <span class="n">response_name</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_features</span> <span class="o">=</span> <span class="n">n_features</span>

        <span class="n">other_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_other_parameter</span><span class="p">()</span>
        <span class="n">a_parameter_provided</span> <span class="o">=</span> <span class="n">other_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span><span class="p">:</span>
            <span class="n">other_val</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">distributions_with_extra_param</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;dalaplace&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dnbinom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dchisq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dfnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;drectnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dgnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dlgnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dbcnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="n">distributions_with_extra_param</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
        <span class="p">):</span>
            <span class="n">n_params</span> <span class="o">=</span> <span class="n">n_features</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbeta&quot;</span><span class="p">:</span>
            <span class="n">n_params</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_features</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_params</span> <span class="o">=</span> <span class="n">n_features</span>

        <span class="n">B_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_params</span><span class="p">)</span>

        <span class="n">log_link_distributions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;dinvgauss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dgamma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dexp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dnbinom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dbinom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dgeom&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;plogis&quot;</span><span class="p">,</span> <span class="s2">&quot;pnorm&quot;</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">bc_transform</span>

            <span class="n">y_bc</span> <span class="o">=</span> <span class="n">bc_transform</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">B_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_bc</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dpois&quot;</span><span class="p">:</span>
            <span class="n">mu_insample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">XtX_mu</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span> <span class="o">*</span> <span class="n">mu_insample</span>
                <span class="n">B_init_for_lstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">XtX_mu</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">mu_insample</span><span class="p">))</span>
                <span class="n">B_init</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">y_pos</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">X_pos</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">B_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_pos</span><span class="p">),</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;dlnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dllaplace&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dls&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dlgnorm&quot;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">log_link_distributions</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">y_pos</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">X_pos</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">B_init_for_lstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span>
                        <span class="n">X_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_pos</span><span class="p">),</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="n">distributions_with_extra_param</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
                    <span class="p">):</span>
                        <span class="n">B_init</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">B_init</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">B_init_for_lstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span><span class="p">:</span>
                    <span class="n">B_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="n">B_init</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">B_init</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbcnorm&quot;</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">bc_transform</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">B_init_for_lstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span>
                        <span class="n">X</span><span class="p">,</span> <span class="n">bc_transform</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">B_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
                    <span class="n">B_init</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">B_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span>
                        <span class="n">X</span><span class="p">,</span> <span class="n">bc_transform</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_bc</span><span class="p">),</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dchisq&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">B_init_for_lstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span><span class="p">:</span>
                    <span class="n">B_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">B_init</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">B_init</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dlogitnorm&quot;</span><span class="p">,):</span>
            <span class="n">y_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="n">y_transformed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_clip</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_clip</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">B_init_for_lstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_transformed</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="n">distributions_with_extra_param</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
                <span class="p">):</span>
                    <span class="n">B_init</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">B_init</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbeta&quot;</span><span class="p">:</span>
            <span class="n">y_clip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">B_half</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_clip</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_clip</span><span class="p">)),</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span>
                    <span class="mi">0</span>
                <span class="p">]</span>
                <span class="n">B_init</span><span class="p">[:</span><span class="n">n_features</span><span class="p">]</span> <span class="o">=</span> <span class="n">B_half</span>
                <span class="n">B_init</span><span class="p">[</span><span class="n">n_features</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">B_half</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="n">distributions_with_extra_param</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">B_init_for_lstsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">B_init</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">B_init_for_lstsq</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># Set distribution-specific initial values for extra param</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dfnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;drectnorm&quot;</span><span class="p">):</span>
                <span class="n">B_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dalaplace&quot;</span><span class="p">:</span>
                <span class="n">B_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dgnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;dlgnorm&quot;</span><span class="p">):</span>
                <span class="n">B_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dnbinom&quot;</span><span class="p">:</span>
                <span class="n">B_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">B_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">B_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>

        <span class="n">print_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;print_level&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">iteration_count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last_cf_value</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">objective_func</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">grad</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">grad</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">grad</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">cf_value</span> <span class="o">=</span> <span class="n">cf</span><span class="p">(</span>
                <span class="n">B</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span>
                <span class="n">y</span><span class="p">,</span>
                <span class="n">X</span><span class="p">,</span>
                <span class="n">ar_order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">i_order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">lambda_val</span><span class="o">=</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lambda_l1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;LASSO&quot;</span>
                    <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_l2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;RIDGE&quot;</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">other</span><span class="o">=</span><span class="n">other_val</span><span class="p">,</span>
                <span class="n">a_parameter_provided</span><span class="o">=</span><span class="n">a_parameter_provided</span><span class="p">,</span>
                <span class="n">trim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trim</span><span class="p">,</span>
                <span class="n">lambda_bc</span><span class="o">=</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lambda_bc</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbcnorm&quot;</span> <span class="ow">and</span> <span class="n">a_parameter_provided</span>
                    <span class="k">else</span> <span class="mf">0.0</span>
                <span class="p">),</span>
                <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbinom&quot;</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">print_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">iteration_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">last_cf_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf_value</span>
                <span class="k">if</span> <span class="n">iteration_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">print_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">: B = </span><span class="si">{</span><span class="n">B</span><span class="si">}</span><span class="s2">, CF = </span><span class="si">{</span><span class="n">cf_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">cf_value</span>

        <span class="n">algorithm_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algorithm&quot;</span><span class="p">,</span> <span class="s2">&quot;NLOPT_LN_NELDERMEAD&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">algorithm_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NLOPT_ALGORITHMS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown algorithm: </span><span class="si">{</span><span class="n">algorithm_name</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Choose from: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">NLOPT_ALGORITHMS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">algorithm</span> <span class="o">=</span> <span class="n">NLOPT_ALGORITHMS</span><span class="p">[</span><span class="n">algorithm_name</span><span class="p">]</span>

        <span class="n">opt</span> <span class="o">=</span> <span class="n">nlopt</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="n">algorithm</span><span class="p">,</span> <span class="n">n_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="n">distributions_with_extra_param</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
        <span class="p">):</span>
            <span class="n">lower_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_features</span>
            <span class="n">upper_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_features</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dalaplace&quot;</span><span class="p">,</span> <span class="s2">&quot;dbcnorm&quot;</span><span class="p">):</span>
                <span class="n">upper_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_params</span>
            <span class="n">upper_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_params</span>

        <span class="n">opt</span><span class="o">.</span><span class="n">set_lower_bounds</span><span class="p">(</span><span class="n">lower_bounds</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">set_upper_bounds</span><span class="p">(</span><span class="n">upper_bounds</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">set_min_objective</span><span class="p">(</span><span class="n">objective_func</span><span class="p">)</span>

        <span class="n">opt</span><span class="o">.</span><span class="n">set_xtol_rel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xtol_rel&quot;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">))</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">set_xtol_abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;xtol_abs&quot;</span><span class="p">,</span> <span class="mf">1e-8</span><span class="p">))</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">set_ftol_rel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ftol_rel&quot;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">))</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">set_ftol_abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ftol_abs&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">maxeval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;maxeval&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">maxeval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;dlnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;dlogitnorm&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;likelihood&quot;</span><span class="p">,</span> <span class="s2">&quot;MSE&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">maxeval</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxeval</span> <span class="o">=</span> <span class="n">n_params</span> <span class="o">*</span> <span class="mi">40</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;LASSO&quot;</span><span class="p">,</span> <span class="s2">&quot;RIDGE&quot;</span><span class="p">):</span>
                <span class="n">maxeval</span> <span class="o">=</span> <span class="n">n_params</span> <span class="o">*</span> <span class="mi">200</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_l1</span> <span class="o">==</span> <span class="mf">1.0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;RIDGE&quot;</span><span class="p">:</span>
                    <span class="n">maxeval</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">opt</span><span class="o">.</span><span class="n">set_maxeval</span><span class="p">(</span><span class="n">maxeval</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">set_maxtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;maxtime&quot;</span><span class="p">,</span> <span class="mi">600</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">B_opt</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">B_init</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">get_numevals</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">last_optimum_value</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nlopt_result_</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">last_optimize_result</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimization failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">B_opt</span> <span class="o">=</span> <span class="n">B_init</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nlopt_result_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">distributions_with_extra_param</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;dalaplace&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dnbinom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dchisq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dfnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;drectnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dgnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dlgnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dbcnorm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">n_features</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="n">distributions_with_extra_param</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">=</span> <span class="n">B_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="o">=</span> <span class="n">B_opt</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">B_opt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbeta&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">=</span> <span class="n">B_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="o">=</span> <span class="n">B_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">n_features</span><span class="p">]</span> <span class="k">if</span> <span class="n">n_features</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span> <span class="o">=</span> <span class="n">B_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="o">=</span> <span class="n">B_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">B_opt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="n">distributions_with_extra_param</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
        <span class="p">):</span>
            <span class="n">B_for_mu</span> <span class="o">=</span> <span class="n">B_opt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">other_val</span> <span class="o">=</span> <span class="n">B_opt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbeta&quot;</span><span class="p">:</span>
            <span class="n">B_for_mu</span> <span class="o">=</span> <span class="n">B_opt</span><span class="p">[:</span><span class="n">n_features</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">B_for_mu</span> <span class="o">=</span> <span class="n">B_opt</span>

        <span class="n">linear_pred</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="n">B_for_mu</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;dinvgauss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dgamma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dexp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dpois&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dnbinom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dbinom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dgeom&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">mu_computed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">linear_pred</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbeta&quot;</span><span class="p">:</span>
            <span class="n">mu_computed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">linear_pred</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mu_computed</span> <span class="o">=</span> <span class="n">linear_pred</span>

        <span class="n">fitter_return</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mu&quot;</span><span class="p">:</span> <span class="n">mu_computed</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="n">other_val</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="n">scaler_internal</span><span class="p">(</span>
            <span class="n">B_opt</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
            <span class="n">y</span><span class="p">,</span>
            <span class="n">X</span><span class="p">,</span>
            <span class="n">fitter_return</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span>
            <span class="n">other_val</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">fitter_return</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other_</span> <span class="o">=</span> <span class="n">other_val</span>

        <span class="n">lambda_bc_val</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">other_val</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbcnorm&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
            <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_bc</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbcnorm&quot;</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitted_values_</span> <span class="o">=</span> <span class="n">extractor_fitted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
            <span class="n">fitter_return</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span>
            <span class="n">scale</span><span class="p">,</span>
            <span class="n">lambda_bc_val</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="o">=</span> <span class="n">extractor_residuals</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
            <span class="n">fitter_return</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="p">,</span>
            <span class="n">lambda_bc_val</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loss_value</span> <span class="o">=</span> <span class="n">objective_func</span><span class="p">(</span><span class="n">B_opt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_params</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;likelihood&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_lik</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_loss_value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbeta&quot;</span><span class="p">:</span>
                <span class="n">n_params_calc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_features</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_params_calc</span> <span class="o">=</span> <span class="n">n_features</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;dexp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dpois&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dgeom&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dbinom&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;plogis&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pnorm&quot;</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">n_params_calc</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="n">distributions_with_extra_param</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span>
                    <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="s2">&quot;dfnorm&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;drectnorm&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;dchisq&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;dnbinom&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">n_params_calc</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aic</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_params_calc</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_lik</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bic</span> <span class="o">=</span> <span class="n">n_params_calc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_lik</span>

            <span class="k">if</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="n">n_params_calc</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_aicc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aic</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n_params_calc</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_params_calc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">n_samples</span> <span class="o">-</span> <span class="n">n_params_calc</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bicc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_lik</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="n">n_params_calc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_samples</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_samples</span> <span class="o">-</span> <span class="n">n_params_calc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_aicc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bicc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df_residual</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="n">n_params</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_X_train_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_train_</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="n">scaler_internal</span><span class="p">(</span>
            <span class="n">B_opt</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
            <span class="n">y</span><span class="p">,</span>
            <span class="n">X</span><span class="p">,</span>
            <span class="n">fitter_return</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">],</span>
            <span class="n">other_val</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
            <span class="n">n_samples</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span> <span class="o">=</span> <span class="n">scale</span>

        <span class="n">XtX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span>
        <span class="n">XtX</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">XtX</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_XtX_inv_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">XtX</span><span class="p">)</span>

        <span class="c1"># Store optimization state for Hessian-based vcov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_B_opt_</span> <span class="o">=</span> <span class="n">B_opt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_a_parameter_provided_</span> <span class="o">=</span> <span class="n">a_parameter_provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_other_val_</span> <span class="o">=</span> <span class="n">other_val</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_time_elapsed</span> <span class="o">=</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="ALM.vcov">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.ALM.vcov">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">vcov</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate variance-covariance matrix of parameter estimates.</span>

<span class="sd">        Uses distribution-specific methods matching R&#39;s vcov.alm():</span>
<span class="sd">        - Normal-like + likelihood/MSE: sigma^2 * (X&#39;X)^-1</span>
<span class="sd">        - Poisson + likelihood: inverse Fisher information</span>
<span class="sd">        - Everything else: inverse numerical Hessian of cost function</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vcov_matrix : np.ndarray</span>
<span class="sd">            Covariance matrix of shape (n_params, n_params)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_train_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_train_</span>
        <span class="n">n_vars</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span>

        <span class="c1"># Path 1: Analytical for normal-like distributions with likelihood/MSE</span>
        <span class="n">normal_like</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;dnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;dlnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;dbcnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;dlogitnorm&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">distribution</span> <span class="ow">in</span> <span class="n">normal_like</span> <span class="ow">and</span> <span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;likelihood&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;MSE&quot;</span><span class="p">:</span>
            <span class="n">XtX</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">XtX</span><span class="p">)</span>
                <span class="n">XtX_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)))</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                <span class="n">XtX_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">XtX</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">XtX_inv</span>

        <span class="c1"># Path 2: Analytical for Poisson with likelihood</span>
        <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dpois&quot;</span> <span class="ow">and</span> <span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;likelihood&quot;</span><span class="p">:</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted</span>
            <span class="n">FI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_vars</span><span class="p">,</span> <span class="n">n_vars</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)):</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">FI</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span> <span class="o">*</span> <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">FI</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)))</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">FI</span><span class="p">)</span>

        <span class="c1"># Path 3: Hessian-based for everything else</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vcov_hessian</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">n_vars</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_vcov_hessian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">n_vars</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute vcov via numerical Hessian of the cost function.&quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_train_</span>
        <span class="n">a_parameter_provided</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_a_parameter_provided_</span>
        <span class="n">other_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other_val_</span>

        <span class="c1"># B for the regression coefficients only (not extra param)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span>
            <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;dalaplace&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dnbinom&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dchisq&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dfnorm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;drectnorm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dgnorm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dlgnorm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dbcnorm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
        <span class="p">):</span>
            <span class="n">B_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_opt_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbeta&quot;</span><span class="p">:</span>
            <span class="n">B_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_opt_</span><span class="p">[:</span><span class="n">n_vars</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">B_reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_opt_</span>

        <span class="n">lambda_val</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lambda_l1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;LASSO&quot;</span>
            <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_l2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">==</span> <span class="s2">&quot;RIDGE&quot;</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">lambda_bc_val</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lambda_bc</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbcnorm&quot;</span> <span class="ow">and</span> <span class="n">a_parameter_provided</span>
            <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cf_wrapper</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span>
                <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;dalaplace&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dnbinom&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dchisq&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dfnorm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;drectnorm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dgnorm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dlgnorm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dbcnorm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">a_parameter_provided</span>
            <span class="p">):</span>
                <span class="n">B_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">other_val</span><span class="p">],</span> <span class="n">B</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbeta&quot;</span><span class="p">:</span>
                <span class="n">B_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_opt_</span><span class="p">[</span><span class="n">n_vars</span><span class="p">:]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">B_full</span> <span class="o">=</span> <span class="n">B</span>
            <span class="k">return</span> <span class="n">cf</span><span class="p">(</span>
                <span class="n">B_full</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span>
                <span class="n">y</span><span class="p">,</span>
                <span class="n">X</span><span class="p">,</span>
                <span class="n">ar_order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">i_order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">lambda_val</span><span class="o">=</span><span class="n">lambda_val</span><span class="p">,</span>
                <span class="n">other</span><span class="o">=</span><span class="n">other_val</span><span class="p">,</span>
                <span class="n">a_parameter_provided</span><span class="o">=</span><span class="n">a_parameter_provided</span><span class="p">,</span>
                <span class="n">trim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trim</span><span class="p">,</span>
                <span class="n">lambda_bc</span><span class="o">=</span><span class="n">lambda_bc_val</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbinom&quot;</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">FI</span> <span class="o">=</span> <span class="n">_numerical_hessian</span><span class="p">(</span><span class="n">cf_wrapper</span><span class="p">,</span> <span class="n">B_reg</span><span class="p">)</span>

        <span class="c1"># Check for broken variables (all-zero or NaN rows)</span>
        <span class="n">broken</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">FI</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">FI</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">broken</span><span class="p">):</span>
            <span class="n">FI</span> <span class="o">=</span> <span class="n">_numerical_hessian</span><span class="p">(</span><span class="n">cf_wrapper</span><span class="p">,</span> <span class="n">B_reg</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">6</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">FI</span><span class="p">)</span>
            <span class="n">vcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">FI</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                <span class="n">vcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">FI</span><span class="p">)</span>

        <span class="c1"># Fix negative diagonal elements</span>
        <span class="n">neg_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vcov</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">neg_diag</span><span class="p">):</span>
            <span class="n">diag_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vcov</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">diag_vals</span><span class="p">[</span><span class="n">neg_diag</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diag_vals</span><span class="p">[</span><span class="n">neg_diag</span><span class="p">])</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">vcov</span><span class="p">,</span> <span class="n">diag_vals</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vcov</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;confidence&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate conditional variance for prediction intervals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : np.ndarray</span>
<span class="sd">            Design matrix for predictions.</span>
<span class="sd">        interval : str</span>
<span class="sd">            Type of interval: &quot;confidence&quot; or &quot;prediction&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        variances : np.ndarray</span>
<span class="sd">            Variance values for each observation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vcov_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcov</span><span class="p">()</span>
        <span class="n">variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">vcov_matrix</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;prediction&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">variances</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">variances</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_quantiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">side</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate lower and upper quantiles for prediction intervals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mean : np.ndarray</span>
<span class="sd">            Predicted mean values.</span>
<span class="sd">        variances : np.ndarray</span>
<span class="sd">            Variance values.</span>
<span class="sd">        interval : str</span>
<span class="sd">            Type of interval: &quot;confidence&quot; or &quot;prediction&quot;.</span>
<span class="sd">        level : float or list</span>
<span class="sd">            Confidence level(s).</span>
<span class="sd">        side : str</span>
<span class="sd">            Side of interval: &quot;both&quot;, &quot;upper&quot;, or &quot;lower&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lower : np.ndarray or None</span>
<span class="sd">            Lower bounds.</span>
<span class="sd">        upper : np.ndarray or None</span>
<span class="sd">            Upper bounds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">level</span> <span class="o">=</span> <span class="p">[</span><span class="n">level</span><span class="p">]</span>

        <span class="n">n_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;upper&quot;</span><span class="p">:</span>
            <span class="n">level_low</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_levels</span>
            <span class="n">level_up</span> <span class="o">=</span> <span class="n">level</span>
        <span class="k">elif</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;lower&quot;</span><span class="p">:</span>
            <span class="n">level_low</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lev</span> <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="n">level</span><span class="p">]</span>
            <span class="n">level_up</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_levels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">level_low</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lev</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="n">level</span><span class="p">]</span>
            <span class="n">level_up</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">lev</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">lev</span> <span class="ow">in</span> <span class="n">level</span><span class="p">]</span>

        <span class="n">quantiles_low</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">level_low</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_residual_</span><span class="p">)</span>
        <span class="n">quantiles_up</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">level_up</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_residual_</span><span class="p">)</span>

        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">))</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_levels</span><span class="p">):</span>
            <span class="n">lower</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">quantiles_low</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">se</span>
            <span class="n">upper</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">quantiles_up</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">se</span>

        <span class="k">if</span> <span class="n">n_levels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;upper&quot;</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;lower&quot;</span><span class="p">:</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>

<div class="viewcode-block" id="ALM.predict">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.ALM.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">side</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PredictionResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Predict using the fitted model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_features)</span>
<span class="sd">            Design matrix. Should have same number of features as training data.</span>
<span class="sd">        interval : {&quot;none&quot;, &quot;confidence&quot;, &quot;prediction&quot;}, default=&quot;none&quot;</span>
<span class="sd">            Type of interval to calculate:</span>
<span class="sd">            - &quot;none&quot;: No intervals, return only point forecasts</span>
<span class="sd">            - &quot;confidence&quot;: Confidence interval for the mean</span>
<span class="sd">            - &quot;prediction&quot;: Prediction interval for new observations</span>
<span class="sd">        level : float or list of float, default=0.95</span>
<span class="sd">            Confidence level(s) for intervals. Can be a single float (e.g., 0.95)</span>
<span class="sd">            or a list of floats (e.g., [0.8, 0.9, 0.95]). Default is 0.95 (95%).</span>
<span class="sd">        side : {&quot;both&quot;, &quot;upper&quot;, &quot;lower&quot;}, default=&quot;both&quot;</span>
<span class="sd">            Side of interval:</span>
<span class="sd">            - &quot;both&quot;: Return both lower and upper bounds</span>
<span class="sd">            - &quot;upper&quot;: Return only upper bounds</span>
<span class="sd">            - &quot;lower&quot;: Return only lower bounds</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PredictionResult</span>
<span class="sd">            Object with the following attributes:</span>
<span class="sd">            - mean : np.ndarray - Predicted values (point forecasts)</span>
<span class="sd">            - lower : np.ndarray or None - Lower prediction bounds</span>
<span class="sd">            - upper : np.ndarray or None - Upper prediction bounds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_values_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">interval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;interval must be &#39;none&#39;, &#39;confidence&#39;, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or &#39;prediction&#39;, got </span><span class="si">{</span><span class="n">interval</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">side</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="s2">&quot;upper&quot;</span><span class="p">,</span> <span class="s2">&quot;lower&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;side must be &#39;both&#39;, &#39;upper&#39;, or &#39;lower&#39;, got </span><span class="si">{</span><span class="n">side</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;X has </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> features, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but model was fitted with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_features</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coef</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span><span class="p">])</span>

        <span class="n">mu</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="n">B</span>

        <span class="n">mean</span> <span class="o">=</span> <span class="n">extractor_fitted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
            <span class="n">mu</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lambda_bc</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbcnorm&quot;</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">variances</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">interval</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_variance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_quantiles</span><span class="p">(</span>
                <span class="n">mean</span><span class="p">,</span> <span class="n">variances</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">side</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">PredictionResult</span><span class="p">(</span>
            <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span>
            <span class="n">lower</span><span class="o">=</span><span class="n">lower</span><span class="p">,</span>
            <span class="n">upper</span><span class="o">=</span><span class="n">upper</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
            <span class="n">variances</span><span class="o">=</span><span class="n">variances</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="n">side</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ALM.score">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.ALM.score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;likelihood&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate model score.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like of shape (n_samples, n_features)</span>
<span class="sd">            Design matrix.</span>
<span class="sd">        y : array-like of shape (n_samples,)</span>
<span class="sd">            True values.</span>
<span class="sd">        metric : str, optional</span>
<span class="sd">            Metric to use: &quot;likelihood&quot;, &quot;MSE&quot;, &quot;MAE&quot;, or &quot;R2&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        score : float</span>
<span class="sd">            Score value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_pred_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred_result</span><span class="o">.</span><span class="n">mean</span>

        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;likelihood&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_lik</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_lik</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">log_lik</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">y_otU</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dlnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;dllaplace&quot;</span><span class="p">,</span> <span class="s2">&quot;dls&quot;</span><span class="p">,</span> <span class="s2">&quot;dlgnorm&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">y</span>
            <span class="p">)</span>
            <span class="n">mu_otU</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">y_pred</span><span class="p">[</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dlnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;dllaplace&quot;</span><span class="p">,</span> <span class="s2">&quot;dls&quot;</span><span class="p">,</span> <span class="s2">&quot;dlgnorm&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">y_pred</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dnorm&quot;</span><span class="p">:</span>
                <span class="n">log_lik</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">dnorm</span><span class="p">(</span><span class="n">y_otU</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mu_otU</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">log_lik</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;MSE&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;MAE&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span>
            <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ss_res</span> <span class="o">/</span> <span class="n">ss_tot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown metric: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of observations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nobs : int</span>
<span class="sd">            Number of observations used in the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_train_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_train_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nparam</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        nparam : int</span>
<span class="sd">            Number of parameters in the model (including intercept and scale).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_train_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>
        <span class="n">n_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_train_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;dexp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dpois&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dgeom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dbinom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plogis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pnorm&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">n_params</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">n_params</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Model residuals.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        residuals : np.ndarray</span>
<span class="sd">            Residuals (y - fitted values).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fitted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fitted : np.ndarray</span>
<span class="sd">            Fitted values (predictions on training data).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_values_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitted_values_</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">actuals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Actual values (response variable).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        actuals : np.ndarray</span>
<span class="sd">            Actual response values from training data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_train_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_train_</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alias for actuals.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : np.ndarray</span>
<span class="sd">            Original in-sample observations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actuals</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_param</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parameter count information.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        n_param : dict</span>
<span class="sd">            Dictionary containing parameter count information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nparam</span><span class="p">,</span>
            <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_residual_</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">formula</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Formula string used to fit the model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        formula : str or None</span>
<span class="sd">            Formula string if provided during fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formula_</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Residual standard error (sigma).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sigma : float</span>
<span class="sd">            Residual standard error, computed as sqrt(sum(residuals^2) / (n - k))</span>
<span class="sd">            where n is the number of observations and k is the number of parameters</span>
<span class="sd">            (including the scale parameter).</span>
<span class="sd">            For dinvgauss/dgamma/dexp, uses (residuals - 1) since residuals are</span>
<span class="sd">            on a multiplicative scale (y/mu), matching R&#39;s sigma.alm().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_features</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residuals_</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dinvgauss&quot;</span><span class="p">,</span> <span class="s2">&quot;dgamma&quot;</span><span class="p">,</span> <span class="s2">&quot;dexp&quot;</span><span class="p">):</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">resid</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loglik</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log-likelihood (ADAM-compatible name).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loglik : float or None</span>
<span class="sd">            Log-likelihood value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_lik</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log-likelihood (backward-compatible alias for loglik).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loglik</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Akaike Information Criterion.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aic</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aicc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Corrected Akaike Information Criterion.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aicc</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bayesian Information Criterion.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bic</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bicc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Corrected Bayesian Information Criterion.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bicc</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Final value of the loss function.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scale parameter.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scale</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">time_elapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Time elapsed during model fitting (seconds).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_elapsed</span>

    <span class="nd">@time_elapsed</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">time_elapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_elapsed</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">df_residual_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Residual degrees of freedom.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_residual</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">distribution_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Distribution name (ADAM convention with trailing _).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loss function name (ADAM convention with trailing _).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coef</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimated coefficients (slope parameters, excluding intercept).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        coef : np.ndarray</span>
<span class="sd">            Coefficient vector (without intercept).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;All coefficients including intercept as named vector.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        coefficients : np.ndarray</span>
<span class="sd">            Full coefficient vector with names (intercept + slopes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;(Intercept)&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coef</span><span class="p">)):</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="ALM.summary">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.ALM.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SummaryResult&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Model summary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        level : float, optional</span>
<span class="sd">            Confidence level for parameter intervals. Default is 0.95.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SummaryResult</span>
<span class="sd">            Summary of the model with coefficient estimates, standard errors,</span>
<span class="sd">            t-statistics, p-values, and confidence intervals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.methods.summary</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummaryResult</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>

        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span><span class="p">])</span>
        <span class="n">vcov_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcov</span><span class="p">()</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vcov_matrix</span><span class="p">))</span>
        <span class="n">t_stat</span> <span class="o">=</span> <span class="n">coefficients</span> <span class="o">/</span> <span class="n">se</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t_stat</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_residual_</span><span class="p">))</span>

        <span class="n">t_crit</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_residual_</span><span class="p">)</span>
        <span class="n">lower_ci</span> <span class="o">=</span> <span class="n">coefficients</span> <span class="o">-</span> <span class="n">t_crit</span> <span class="o">*</span> <span class="n">se</span>
        <span class="n">upper_ci</span> <span class="o">=</span> <span class="n">coefficients</span> <span class="o">+</span> <span class="n">t_crit</span> <span class="o">*</span> <span class="n">se</span>

        <span class="n">response_var</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_name</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formula_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;~&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formula_</span><span class="p">:</span>
            <span class="n">response_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formula_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">SummaryResult</span><span class="p">(</span>
            <span class="n">coefficients</span><span class="o">=</span><span class="n">coefficients</span><span class="p">,</span>
            <span class="n">se</span><span class="o">=</span><span class="n">se</span><span class="p">,</span>
            <span class="n">t_stat</span><span class="o">=</span><span class="n">t_stat</span><span class="p">,</span>
            <span class="n">p_value</span><span class="o">=</span><span class="n">p_value</span><span class="p">,</span>
            <span class="n">lower_ci</span><span class="o">=</span><span class="n">lower_ci</span><span class="p">,</span>
            <span class="n">upper_ci</span><span class="o">=</span><span class="n">upper_ci</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">df_residual</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_residual_</span><span class="p">,</span>
            <span class="n">distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
            <span class="n">log_lik</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_lik</span><span class="p">,</span>
            <span class="n">aic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aic</span><span class="p">,</span>
            <span class="n">bic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bic</span><span class="p">,</span>
            <span class="n">nobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nobs</span><span class="p">,</span>
            <span class="n">nparam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nparam</span><span class="p">,</span>
            <span class="n">response_variable</span><span class="o">=</span><span class="n">response_var</span><span class="p">,</span>
            <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span>
            <span class="n">aicc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aicc</span><span class="p">,</span>
            <span class="n">bicc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bicc</span><span class="p">,</span>
            <span class="n">feature_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_names</span><span class="p">,</span>
            <span class="n">time_elapsed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ALM.confint">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.ALM.confint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">confint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Confidence intervals for parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parm : int or list of int, optional</span>
<span class="sd">            Which parameters to include. If None, all parameters are included.</span>
<span class="sd">            0 = intercept, 1, 2, ... = coefficients.</span>
<span class="sd">        level : float, optional</span>
<span class="sd">            Confidence level. Default is 0.95.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        confint : np.ndarray</span>
<span class="sd">            Array with shape (n_params, 2) containing lower and upper bounds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model not fitted. Call fit() first.&quot;</span><span class="p">)</span>

        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">intercept_</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span><span class="p">])</span>
        <span class="n">vcov_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcov</span><span class="p">()</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vcov_matrix</span><span class="p">))</span>

        <span class="n">t_crit</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_residual_</span><span class="p">)</span>
        <span class="n">lower_ci</span> <span class="o">=</span> <span class="n">coefficients</span> <span class="o">-</span> <span class="n">t_crit</span> <span class="o">*</span> <span class="n">se</span>
        <span class="n">upper_ci</span> <span class="o">=</span> <span class="n">coefficients</span> <span class="o">+</span> <span class="n">t_crit</span> <span class="o">*</span> <span class="n">se</span>

        <span class="k">if</span> <span class="n">parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="p">[</span><span class="n">parm</span><span class="p">]</span>
            <span class="n">lower_ci</span> <span class="o">=</span> <span class="n">lower_ci</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span>
            <span class="n">upper_ci</span> <span class="o">=</span> <span class="n">upper_ci</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">lower_ci</span><span class="p">,</span> <span class="n">upper_ci</span><span class="p">])</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_other_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the additional parameter for distributions that require it.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dalaplace&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dgnorm&quot;</span><span class="p">,</span> <span class="s2">&quot;dlgnorm&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;dbcnorm&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_bc</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="s2">&quot;dchisq&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dnbinom&quot;</span><span class="p">,):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="ALM.get_params">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.ALM.get_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get model parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : dict</span>
<span class="sd">            Dictionary of model parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;distribution&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span>
            <span class="s2">&quot;occurrence&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurrence</span><span class="p">,</span>
            <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orders</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="s2">&quot;lambda_bc&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_bc</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s2">&quot;nu&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span>
            <span class="s2">&quot;trim&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim</span><span class="p">,</span>
            <span class="s2">&quot;lambda_l1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_l1</span><span class="p">,</span>
            <span class="s2">&quot;lambda_l2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_l2</span><span class="p">,</span>
            <span class="s2">&quot;nlopt_kargs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlopt_kargs</span><span class="p">,</span>
            <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="ALM.set_params">
<a class="viewcode-back" href="../../api/alm.html#greybox.alm.ALM.set_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set model parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **params : dict</span>
<span class="sd">            Parameters to set.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : ALM</span>
<span class="sd">            Model with updated parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.methods.summary</span><span class="w"> </span><span class="kn">import</span> <span class="n">DISTRIBUTION_NAMES</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">dist_name</span> <span class="o">=</span> <span class="n">DISTRIBUTION_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time elapsed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model estimated: ALM(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribution assumed in the model: </span><span class="si">{</span><span class="n">dist_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Loss function type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;; Loss function value: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nobs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of estimated parameters: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nparam</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of degrees of freedom: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df_residual_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Information criteria:&quot;</span><span class="p">)</span>
            <span class="n">ic_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;AIC&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}{</span><span class="s1">&#39;AICc&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}{</span><span class="s1">&#39;BIC&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}{</span><span class="s1">&#39;BICc&#39;</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ic_header</span><span class="p">)</span>
            <span class="n">aicc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aicc</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aicc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">bicc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bicc</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bicc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">ic_vals</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aic</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}{</span><span class="n">aicc</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">bic</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}{</span><span class="n">bicc</span><span class="si">:</span><span class="s2">&gt;10.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ic_vals</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ALM(distribution=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="si">!r}</span><span class="s2">, fitted=True)&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ALM(distribution=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="si">!r}</span><span class="s2">, fitted=False)&quot;</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ivan Svetunkov.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>